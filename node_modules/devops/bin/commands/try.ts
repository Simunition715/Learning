import fs from "fs-extra";
import path from "path";
import url from "url";
import { chalk } from "../lib/util/chalk.js";

const __dirname = url.fileURLToPath(new URL(".", import.meta.url));

// FUnction called replaceColor that colors only matching text. There are three
// parameters, text string for the message, text to match, and color to use.
function replaceColor(
  text: string,
  match: string[] | string,
  color: (typeof chalk)[keyof typeof chalk]
) {
  if (Array.isArray(match)) {
    return match.reduce((acc, m) => {
      return acc.replace(new RegExp(m, "g"), color(m));
    }, text);
  }
  return text.replace(new RegExp(match, "g"), color(match));
}

/**
 * Do all the things
 */
export default async function run(file = "", _args?: string[]) {
  // Look for the file relative to the command folder
  const filepath = path.resolve(__dirname, file);

  // Make sure a file is specified
  if (!file) {
    console.error("Please specify a command file to run.");
    process.exit(1);
  }

  // Exit if file does not exist
  if (!fs.existsSync(filepath)) {
    const message = replaceColor(
      `File does not exist: ${filepath}`,
      filepath,
      chalk.cyanBrightBold
    );
    console.error(message);
    process.exit(1);
  }

  // Import and run the file
  const module = await import(filepath);
  // Run the default export
  await module.default(...(_args || [])).catch((err: Error) => {
    console.warn("Process exited unexpectedly");
    console.warn(err.stack || err.message);
    process.exit(1);
  });
}
