import fs from "fs";
import path from "path";
import { Paths } from "./check-component-structure.js";

/**
 * Recursively find all files in a directory.
 */
export async function getAllComponents(paths: Paths, out?: string[]) {
  const complete = new Set<string>();

  const exec = (dirPath: string, out?: string[]) => {
    const files = fs.readdirSync(dirPath);
    const arrayOfFiles = out || [];
    if (complete.has(dirPath)) return arrayOfFiles;

    for (const file of files) {
      if (complete.has(dirPath)) continue;

      if (fs.statSync(path.resolve(dirPath, file)).isDirectory()) {
        exec(path.resolve(dirPath, file), arrayOfFiles);
      } else {
        // Only add the file if it's a ts or tsx file with the same name as it's
        // directory
        if (file.endsWith(".ts") || file.endsWith(".tsx")) {
          const fileName = file.replace(".tsx", "").replace(".ts", "");

          if (fileName === path.basename(dirPath)) {
            arrayOfFiles.push(path.resolve(dirPath, file));
            complete.add(dirPath);
          }
        }
      }
    }

    return arrayOfFiles;
  };

  return exec(paths.componentsPath, out);
}
