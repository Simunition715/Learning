import shell from "shelljs";
import { gitCurrentBranch } from "./git-current-branch.js";

/**
 * This switches to the branch specified, then reset --hard origin/branch to
 * make sure it reflects the repo, then returns to the current branch.
 */
export const gitUpdateBranch = async (remote: string, branch: string) => {
  const branchBak = await gitCurrentBranch();

  if (!branchBak) {
    console.warn("Could not determine current branch.");
    return false;
  }

  // Checkout the specified branch
  if (shell.exec(`git checkout ${branch}`).code !== 0) {
    console.warn(`Could not checkout branch ${branch}`);
    return false;
  }

  // Perform the reset
  if (shell.exec(`git reset --hard ${remote}/${branch}`).code !== 0) {
    console.warn(`Could not reset branch ${branch}`);

    // Return to the original branch
    if (shell.exec(`git checkout ${branchBak}`).code !== 0) {
      console.warn(`Could not return to original branch ${branchBak}`);
    }

    return false;
  }

  // Return to the original branch
  if (shell.exec(`git checkout ${branchBak}`).code !== 0) {
    console.warn(`Could not return to original branch ${branchBak}`);
    return false;
  }

  return true;
};
