import fs from "fs";
import path from "path";
import { chalk } from "./chalk.js";
import { parseProps } from "./parse-props.js";

/**
 * Custom dotenv routine to reduce dependencies.
 *
 * This takes in the project's .env file and applies the values therein to the
 * process.env object.
 *
 * This ONLY supports simple key/value pairs and does NOT support any complex
 * props file structures.
 */
export function dotenv(targetFile?: string) {
  try {
    // Read the .env file
    const contents = fs.readFileSync(
      path.resolve(targetFile || ".env"),
      "utf8"
    );
    // Parse the file
    const props = parseProps(contents);

    // Apply only simple key value pairs to process.env
    Object.entries(props).forEach(([key, value]) => {
      if (typeof value === "string") {
        process.env[key] = value;
      } else if (typeof value === "number") {
        process.env[key] = value.toString();
      } else if (typeof value === "boolean") {
        process.env[key] = value.toString();
      }
    });
  } catch (err) {
    if (err instanceof Error) {
      console.error(
        chalk.red(
          `Error reading .env file:\n`,
          chalk.yellow(err.stack || err.message)
        )
      );
    }
  }
}
