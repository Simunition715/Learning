import fs from "fs-extra";
import path from "path";
import { chalk } from "../../../util/chalk.js";
import { execSync } from "../../../util/exec-sync.js";

/**
 * Generates types for the build for the target project ui folder.
 */
export async function releaseLibraryTypes() {
  // Must have a component lib folder to consider
  if (!fs.existsSync(path.resolve("ui"))) return;
  // Make sure we have a folder to inject the types into
  fs.ensureDir(path.resolve("dist/ui"));
  // Generate the .d.ts files using tsc command via npx
  console.warn(chalk.yellowBrightBold("Generating .d.ts files..."));

  // Perform the dts generation
  execSync("npx", [
    "tsc",
    "--emitDeclarationOnly",
    "--declaration",
    "--outDir",
    "dist/types",
    "--project",
    path.resolve("tsconfig.json"),
  ]);

  // Delete the generated type of every folder EXCEPT the ui and util folder
  const folders = fs.readdirSync(path.resolve("dist/types"));
  for (const folder of folders) {
    if (folder === "ui" || folder === "util") continue;
    console.warn(chalk.yellowBright(`Removing types for folder: ${folder}`));
    fs.removeSync(path.resolve("dist/types", folder));
  }
}
