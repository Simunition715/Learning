import * as Vite from "vite";
import fs from "fs-extra";
import path from "path";
import { buildViteConfig } from "../../build-vite-config.js";
import { chalk } from "../../../util/chalk.js";
import { targetProjectDependencies } from "../../../target-project/target-project-dependencies.js";

/**
 * This performs the bundling process for distribution.
 */
export default async function run() {
  console.warn(chalk.yellowBrightBold("Starting Vite client build..."));
  if (!fs.existsSync(path.resolve("app/client/index.ts"))) {
    console.warn(
      "Tried to start development process for the app client, but no entry file was found."
    );
    return;
  }

  const config = await buildViteConfig();

  config.root = path.resolve("app/client");
  config.build!.outDir = path.resolve("build/client");

  config.build!.rollupOptions!.external = Object.keys(
    await targetProjectDependencies()
  );

  await Vite.build(config);
  console.warn(chalk.yellowBrightBold("Vite client build process started..."));
}
